// IpruBudgetX - Multi-Database Prisma Schema
// Production-grade schema with all models and relations
// Supports seamless database switching via configuration
//
// SUPPORTED DATABASES:
// - PostgreSQL (Default - Supabase) ‚Üê Current
// - MySQL
// - Microsoft SQL Server
// - SQLite
//
// TO SWITCH DATABASES (Under 1 Minute):
// 1. Change provider below to: postgresql, mysql, sqlserver, or sqlite
// 2. Update DATABASE_URL in .env with appropriate connection string
// 3. Run: npx prisma generate
// 4. Run: npx prisma migrate dev --name init
//
// NO APPLICATION CODE CHANGES REQUIRED!

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"  // Change to: mysql, sqlserver, or sqlite
  url      = env("DATABASE_URL")
}

// User Model
// Stores system users with authentication, role information, and preferences
model User {
  id              String   @id @default(cuid())
  name            String
  email           String   @unique
  passwordHash    String
  role            String
  departmentId    String?
  isLocked        Boolean  @default(false)
  failedAttempts  Int      @default(0)
  theme           String   @default("light")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  department      Department?       @relation(fields: [departmentId], references: [id])
  budgetRequests  BudgetRequest[]   @relation("RequestCreator")
  approvalRecords ApprovalRecord[]
  auditLogs       AuditLog[]

  @@map("users")
  @@index([email])
  @@index([departmentId])
}

// Department Model
// Organizational departments for user assignment
model Department {
  id             String          @id @default(cuid())
  name           String          @unique
  createdAt      DateTime        @default(now())

  users          User[]
  budgetRequests BudgetRequest[]

  @@map("departments")
}

// BudgetRequest Model
// CAPEX/OPEX budget requests with approval workflow
model BudgetRequest {
  id              String   @id @default(cuid())
  type            String
  amount          Float
  category        String
  justification   String   @db.Text
  departmentId    String
  requesterId     String
  status          String   @default("DRAFT")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  department      Department        @relation(fields: [departmentId], references: [id])
  requester       User              @relation("RequestCreator", fields: [requesterId], references: [id])
  approvalRecords ApprovalRecord[]

  @@map("budget_requests")
  @@index([status])
  @@index([requesterId])
  @@index([departmentId])
}

// ApprovalRecord Model
// Tracks approval workflow for each budget request
model ApprovalRecord {
  id              String   @id @default(cuid())
  requestId       String
  approverId      String
  role            String
  decision        String
  comments        String?  @db.Text
  timestamp       DateTime @default(now())

  request         BudgetRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  approver        User          @relation(fields: [approverId], references: [id])

  @@map("approval_records")
  @@index([requestId])
  @@index([approverId])
}

// AuditLog Model
// System-wide audit trail for all actions
model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  metadata  Json?
  timestamp DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])

  @@map("audit_logs")
  @@index([userId])
  @@index([timestamp])
}

// SystemConfig Model
// Key-value store for system configuration
model SystemConfig {
  key       String   @id
  value     String   @db.Text
  updatedAt DateTime @updatedAt

  @@map("system_config")
}
